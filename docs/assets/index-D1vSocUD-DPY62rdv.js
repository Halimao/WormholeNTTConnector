import{x as p,a as g,y as w,T as u}from"./chunk-KJH4KKG6-CCerRpgp-CDfUDjNe.js";import{dO as B,cQ as M,cO as U,b2 as I,ab as b,cP as l,cR as v,cN as $}from"./index-BGLdF6jF.js";import{p as R}from"./aptos-DjCb_S8U-De6jfdQm.js";import{h as S}from"./unsignedTransaction-BDOQhqcZ-QEsV4D2I.js";import"./index-wFZO7Yy8-CgrhUj91.js";import"./index-CuHybtft-BXlf5Z1L.js";var D=Object.defineProperty,E=(d,e,t)=>e in d?D(d,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):d[e]=t,c=(d,e,t)=>E(d,typeof e!="symbol"?e+"":e,t);const N=[["Mainnet",{depositForBurn:"0xa11ceb0b0700000a0701000802080e031614042a04052e30075e870108e5014000000001000201030004000001050701000100060b0001070304010801020805060108010309080900010002010205060c030e05050208000b010108020108020105010b0101090003060c0b01010900030108000004060c08000e0501030e66756e6769626c655f6173736574066f626a656374167072696d6172795f66756e6769626c655f73746f72650f746f6b656e5f6d657373656e6765720d46756e6769626c654173736574064f626a656374084d6574616461746111616464726573735f746f5f6f626a656374087769746864726177106465706f7369745f666f725f6275726e00000000000000000000000000000000000000000000000000000000000000019bce6734f7b63e835108e3bd8c36743d4709fe435f44791918801d0989640a9d0000010f0b0438000c060a000b060b0138010c050b000b050b020b0311020102",handleReceiveMessage:"0xa11ceb0b0700000a0601000402040403080c051416072a53087d40000001010002000000030203000101040304000103060c0a020a020003060c060a02060a020108000101136d6573736167655f7472616e736d69747465720f746f6b656e5f6d657373656e67657207526563656970740f726563656976655f6d6573736167651668616e646c655f726563656976655f6d657373616765177e17751820e4b4371873ca8c30279be63bdea63b88ed0f2239c2eea10f17729bce6734f7b63e835108e3bd8c36743d4709fe435f44791918801d0989640a9d000001070b000e010e02110011010102"}],["Testnet",{depositForBurn:"0xa11ceb0b0700000a0701000802080e031614042a04052e30075e870108e5014000000001000201030004000001050701000100060b0001070304010801020805060108010309080900010002010205060c030e05050208000b010108020108020105010b0101090003060c0b01010900030108000004060c08000e0501030e66756e6769626c655f6173736574066f626a656374167072696d6172795f66756e6769626c655f73746f72650f746f6b656e5f6d657373656e6765720d46756e6769626c654173736574064f626a656374084d6574616461746111616464726573735f746f5f6f626a656374087769746864726177106465706f7369745f666f725f6275726e00000000000000000000000000000000000000000000000000000000000000015f9b937419dda90aa06c1836b7847f65bbbe3f1217567758dc2488be31a477b90000010f0b0438000c060a000b060b0138010c050b000b050b020b0311020102",handleReceiveMessage:"0xa11ceb0b0700000a0601000402040403080c051416072a53087d40000001010002000000030203000101040304000103060c0a020a020003060c060a02060a020108000101136d6573736167655f7472616e736d69747465720f746f6b656e5f6d657373656e67657207526563656970740f726563656976655f6d6573736167651668616e646c655f726563656976655f6d657373616765081e86cebf457a0c6004f35bd648a2794698f52e0dde09a48619dcd3d4cc23d95f9b937419dda90aa06c1836b7847f65bbbe3f1217567758dc2488be31a477b9000001070b000e010e02110011010102"}]],y=B(N,[0,1]);class h{constructor(e,t,r,s){c(this,"network"),c(this,"chain"),c(this,"provider"),c(this,"contracts"),c(this,"usdcId"),c(this,"tokenMessengerId"),c(this,"messageTransmitterId"),c(this,"moveScripts");var a,i,n;if(this.network=e,this.chain=t,this.provider=r,this.contracts=s,e==="Devnet")throw new Error("CircleBridge not supported on Devnet");const o=M.get(this.network,this.chain);if(!o)throw new Error(`No USDC contract configured for network=${this.network} chain=${this.chain}`);if(!((a=s.cctp)!=null&&a.tokenMessenger))throw new Error(`Circle Token Messenger contract for domain ${t} not found`);if(!((i=s.cctp)!=null&&i.messageTransmitter))throw new Error(`Circle Message Transmitter contract for domain ${t} not found`);if(!y.has(e))throw new Error("No Aptos CCTP move scripts found");this.usdcId=o,this.tokenMessengerId=(n=s.cctp)==null?void 0:n.tokenMessenger,this.messageTransmitterId=s.cctp.messageTransmitter,this.moveScripts=y.get(e)}async*transfer(e,t,r){const s=new p(U.get(this.network,t.chain)),a=g.from(this.usdcId),i=g.from(t.address.toUniversalAddress().toUint8Array()),n=[new w(r),s,i,a],o={bytecode:this.moveScripts.depositForBurn,functionArguments:n};yield this.createUnsignedTx(o,"Aptos.CircleBridge.Transfer")}async isTransferCompleted(e){const t=new p(e.sourceDomain).bcsToBytes(),r=new w(e.nonce).bcsToBytes(),s=I(new Uint8Array([...t,45,...r])),a=b.encode(s);return(await this.provider.view({payload:{function:`${this.messageTransmitterId}::message_transmitter::is_nonce_used`,functionArguments:[a]}}))[0]}async*redeem(e,t,r){const s=[u.U8(l.serialize(t)),u.U8(b.decode(r))],a={bytecode:this.moveScripts.handleReceiveMessage,functionArguments:s};yield this.createUnsignedTx(a,"Aptos.CircleBridge.Redeem")}async parseTransactionDetails(e){var t;const r=await this.provider.getTransactionByHash({transactionHash:e}),s=this.messageTransmitterId.replace(/^0x0+/,"0x"),a=(t=r.events)==null?void 0:t.find(x=>x.type===`${s}::message_transmitter::MessageSent`);if(!a)throw new Error("No MessageSent event found");const i=b.decode(a.data.message),[n,o]=l.deserialize(i),{payload:f}=n,T=f.messageSender,k=f.mintRecipient,m=v(this.network,n.sourceDomain),A=v(this.network,n.destinationDomain),C={chain:m,address:f.burnToken};return{from:{chain:m,address:T},to:{chain:A,address:k},token:C,amount:f.amount,message:n,id:{hash:o}}}static async fromRpc(e,t){const[r,s]=await R.chainFromRpc(e),a=t[s];if(a.network!==r)throw new Error(`Network mismatch: ${a.network} != ${r}`);return new h(r,s,e,a.contracts)}createUnsignedTx(e,t,r=!1){return new S(e,this.network,this.chain,t,r)}}$("Aptos","CircleBridge",h);export{h as AptosCircleBridge};
